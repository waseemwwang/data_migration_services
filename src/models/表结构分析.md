# 表结构分析

迁移数据需要
迁移人信息 user alias email 都可以
迁移描述
迁移备注

做到区分版本

1. 根据迁移前备份数据
    优势：保证了最终数据表的整洁
    劣势：每迁移一次都会生成一份数据库备份，管理较为麻烦，查询历史版本相对麻烦
2. 根据迁移版本保存至数据库
    优势：数据清晰，每个版本数据完整
    劣势：最终数据表会增加冗余字段，影响gpt读取？


### 实现方式


#### 1. 迁移过程前备份数据库

1. 将数据库备份

    ```bash
    import subprocess
    import datetime
    import os

    def backup_database(user, password, database, backup_dir):
        # 获取当前日期时间，用于备份文件名
        current_time = datetime.datetime.now().strftime("%Y%m%d%H%M%S")
        backup_file = os.path.join(backup_dir, f"{database}_backup_{current_time}.sql")

        # 构建 mysqldump 命令
        dump_cmd = [
            "mysqldump",
            "-u", user,
            f"-p{password}",
            database,
            "--result-file", backup_file
        ]

        try:
            # 执行 mysqldump 命令
            result = subprocess.run(dump_cmd, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            print(f"Backup successful: {backup_file}")
            return backup_file
        except subprocess.CalledProcessError as e:
            print(f"Backup failed: {e.stderr.decode()}")
            return None

    if __name__ == "__main__":
        USER = "your_username"
        PASSWORD = "your_password"
        DATABASE = "your_database"
        BACKUP_DIR = "/path/to/backup/directory"

        # 确保备份目录存在
        os.makedirs(BACKUP_DIR, exist_ok=True)

        # 执行备份
        backup_database(USER, PASSWORD, DATABASE, BACKUP_DIR)
    ```

2. 执行数据库迁移

```bash
1. read data 
2. format data
3. update data
4. return success data and faild data
```



全量备份

    操作过程
        在迁移前将数据备份，保存备份文件
        将数据增量写入到数据库中 使用事务同步数据
        如果出现同步异常，回滚备份文件
    
    回滚操作
        将当前数据库备份，保存备份文件
        将要回滚的版本的备份文件，同步至数据库中
    
    能够保持数据库 不存在一些冗余信息如
        新增时间、修改时间、版本信息

增量备份

    操作过程
        存在全量备份数据
        开启增量备份
        开始同步数据
        在数据库中增加版本信息
        在对应的数据中保存版本信息
        使用事务同步数据。

    回滚版本
        回复全量备份数据，依次读取对应版本的增量数据
        或者 当前同步版本为8，要求回滚到版本6，将版本6以后的数据删除即可

    在最终数据库中存在一个version表，以及在对应的数据表中存在version_id信息